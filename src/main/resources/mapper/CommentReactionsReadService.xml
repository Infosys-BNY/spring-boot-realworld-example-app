<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="io.spring.infrastructure.mybatis.readservice.CommentReactionsReadService">
    <select id="getReactionCounts" resultMap="transfer.data.commentReactionCount">
        select
          CR.comment_id as id,
          SUM(CASE WHEN CR.reaction_type = 'LIKE' THEN 1 ELSE 0 END) as likeCount,
          SUM(CASE WHEN CR.reaction_type = 'DISLIKE' THEN 1 ELSE 0 END) as dislikeCount
        from comment_reactions CR
        where CR.comment_id = #{commentId}
        group by CR.comment_id
    </select>
    <select id="getReactionCountsForComments" resultMap="transfer.data.commentReactionCount">
        select
          CR.comment_id as id,
          SUM(CASE WHEN CR.reaction_type = 'LIKE' THEN 1 ELSE 0 END) as likeCount,
          SUM(CASE WHEN CR.reaction_type = 'DISLIKE' THEN 1 ELSE 0 END) as dislikeCount
        from comment_reactions CR
        where CR.comment_id in
        <foreach collection="commentIds" item="item" separator="," open="(" close=")">
            #{item}
        </foreach>
        group by CR.comment_id
    </select>
    <select id="getUserReaction" resultType="io.spring.core.comment.ReactionType">
        select reaction_type
        from comment_reactions
        where comment_id = #{commentId} and user_id = #{userId}
    </select>
    <select id="getUserReactionsForComments" resultMap="commentReaction">
        select
          id reactionId,
          comment_id reactionCommentId,
          user_id reactionUserId,
          reaction_type reactionType,
          created_at reactionCreatedAt
        from comment_reactions
        where comment_id in
        <foreach collection="commentIds" item="item" separator="," open="(" close=")">
            #{item}
        </foreach>
        and user_id = #{userId}
    </select>
    <resultMap id="commentReaction" type="io.spring.core.comment.CommentReaction">
        <id column="reactionId" property="id"/>
        <result column="reactionCommentId" property="commentId"/>
        <result column="reactionUserId" property="userId"/>
        <result column="reactionType" property="type"/>
        <result column="reactionCreatedAt" property="createdAt"/>
    </resultMap>
</mapper>
