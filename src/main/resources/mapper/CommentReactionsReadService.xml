<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="io.spring.infrastructure.mybatis.readservice.CommentReactionsReadService">
    <select id="getReactionCounts" resultMap="transfer.data.commentReactionCount">
        select
          C.id,
          SUM(CASE WHEN CR.reaction_type = 'LIKE' THEN 1 ELSE 0 END) as likeCount,
          SUM(CASE WHEN CR.reaction_type = 'DISLIKE' THEN 1 ELSE 0 END) as dislikeCount
        from comments C
        left join comment_reactions CR on C.id = CR.comment_id
        where C.id = #{commentId}
        group by C.id
    </select>
    <select id="getReactionCountsForComments" resultMap="transfer.data.commentReactionCount">
        select
          C.id,
          SUM(CASE WHEN CR.reaction_type = 'LIKE' THEN 1 ELSE 0 END) as likeCount,
          SUM(CASE WHEN CR.reaction_type = 'DISLIKE' THEN 1 ELSE 0 END) as dislikeCount
        from comments C
        left join comment_reactions CR on C.id = CR.comment_id
        where C.id in
        <foreach collection="commentIds" item="item" separator="," open="(" close=")">
            #{item}
        </foreach>
        group by C.id
    </select>
    <select id="getUserReaction" resultType="io.spring.core.comment.ReactionType">
        select reaction_type
        from comment_reactions
        where comment_id = #{commentId} and user_id = #{userId}
    </select>
    <select id="getUserReactions" resultType="map">
        select comment_id as key, reaction_type as value
        from comment_reactions
        where comment_id in
        <foreach collection="commentIds" item="item" separator="," open="(" close=")">
            #{item}
        </foreach>
        and user_id = #{userId}
    </select>
</mapper>
